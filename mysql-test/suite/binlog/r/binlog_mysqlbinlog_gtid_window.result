###############################
#      Test Setup
###############################
DROP TABLE IF EXISTS t1;
Warnings:
Note	1051	Unknown table 'test.t1'
DROP TABLE IF EXISTS t2;
Warnings:
Note	1051	Unknown table 'test.t2'
RESET MASTER;
######################################
#      Test Group 1
#      Run test cases on local log file
######################################
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
INSERT INTO t1 values (1), (2);
SET @@session.gtid_domain_id= 1;
SET @@session.server_id= 2;
CREATE TABLE t2 (a int);
INSERT INTO t2 values (1);
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
INSERT INTO t1 values (3), (4);
SET @@session.gtid_domain_id= 1;
SET @@session.server_id= 2;
INSERT INTO t2 values (2);
SET @@session.server_id= 3;
INSERT INTO t2 values (3);
SET @@session.server_id= 2;
INSERT INTO t2 values (4);
FLUSH LOGS;
DROP TABLE t1;
DROP TABLE t2;
#
#   Test Case 1:
#   The end of the binlog file resets the server and domain id of the
# session
SET @@session.gtid_domain_id= 10;
SET @@session.server_id= 20;
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0 --stop-position=0-1-2 | MYSQL
include/assert.inc [session gtid_domain_id should not change when reading binlog in GTID mode]
include/assert.inc [session server_id should not change when reading binlog in GTID mode]
SET @@session.gtid_domain_id= 1;
SET @@session.server_id= 2;
DROP TABLE t1;
#
#   Test Case 2:
#   Single GTID range specified
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0 --stop-position=0-1-2 | MYSQL
DROP TABLE t1;
#
#   Test Case 3:
#   Single GTID range with different server_ids
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=1-2-0 --stop-position=1-3-4 | MYSQL
DROP TABLE t1;
DROP TABLE t2;
#
#   Test Case 4:
#   Multiple GTID ranges specified
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0,1-2-0 --stop-position=0-1-3,1-2-3 | MYSQL
DROP TABLE t1;
DROP TABLE t2;
#
#   Test Case 5:
#   Multiple GTID ranges specified where the domain ids are listed in
# different orders between start/stop position
# MYSQL_BINLOG BINLOG_FILE_PARAM --stop-position=0-1-3,1-2-3 --start-position=1-2-0,0-1-0 | MYSQL
DROP TABLE t1;
DROP TABLE t2;
#
#   Test Case 6:
#   Only start position specified
CREATE TABLE t1 (a int);
INSERT INTO t1 values (3), (4);
DROP TABLE t1;
CREATE TABLE t1 (a int);
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-2 | MYSQL
DROP TABLE t1;
DROP TABLE t2;
#
#   Test Case 7:
#   Only stop position specified
# MYSQL_BINLOG BINLOG_FILE_PARAM --stop-position=0-1-2 | MYSQL
DROP TABLE t1;
#
#   Test Case 8:
#   Seq_no=0 in --start-position includes all events for a domain
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0,1-2-0 | MYSQL
DROP TABLE t1;
DROP TABLE t2;
#
#   Test Case 9:
#   Seq_no=0 in --stop-position excludes all events for a domain
# MYSQL_BINLOG BINLOG_FILE_PARAM --stop-position=0-1-0,1-2-0 | MYSQL
#
#   Test Case 10:
#   Output stops for all domain ids when all --stop-position GTID values
# have been hit.
# MYSQL_BINLOG BINLOG_FILE_PARAM --stop-position=0-1-2 | MYSQL
DROP TABLE t1;
#
#   Test Case 11:
#   All GTID events from other domains are printed until the
# --stop-position values are hit
# MYSQL_BINLOG BINLOG_FILE_PARAM --stop-position=1-3-4 | MYSQL
DROP TABLE t1;
DROP TABLE t2;
#   Test Case 12:
#   Scalar and GTID values can be used together for stop or start
# position
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=4 --stop-position=0-1-1 | MYSQL
DROP TABLE t1;
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0 --stop-position=512 | MYSQL
DROP TABLE t1;
#   Test Case 13:
#   Start position is delayed within the binlog
CREATE TABLE t1 (a int);
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-1 --stop-position=0-1-2 | MYSQL
NOT FOUND /WARNING/ in mysqld.1.err
DROP TABLE t1;
#   Test Case 14:
#   Start position is specified twice on the command line
CREATE TABLE t1 (a int);
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0 --start-position=0-1-1 --stop-position=0-1-2 | MYSQL
DROP TABLE t1;
#   Test Case 15:
#   Stop position is specified twice on the command line
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0 --stop-position=0-1-1 --stop-position=0-1-2 | MYSQL
DROP TABLE t1;
######################################
#      Test Group 2
#      Run test cases on remote host
######################################
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
INSERT INTO t1 values (1), (2);
SET @@session.gtid_domain_id= 1;
SET @@session.server_id= 2;
CREATE TABLE t2 (a int);
INSERT INTO t2 values (1);
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
INSERT INTO t1 values (3), (4);
SET @@session.gtid_domain_id= 1;
SET @@session.server_id= 2;
INSERT INTO t2 values (2);
SET @@session.server_id= 3;
INSERT INTO t2 values (3);
SET @@session.server_id= 2;
INSERT INTO t2 values (4);
FLUSH LOGS;
DROP TABLE t1;
DROP TABLE t2;
#
#   Test Case 1:
#   The end of the binlog file resets the server and domain id of the
# session
SET @@session.gtid_domain_id= 10;
SET @@session.server_id= 20;
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0 --stop-position=0-1-2 | MYSQL
include/assert.inc [session gtid_domain_id should not change when reading binlog in GTID mode]
include/assert.inc [session server_id should not change when reading binlog in GTID mode]
SET @@session.gtid_domain_id= 1;
SET @@session.server_id= 2;
DROP TABLE t1;
#
#   Test Case 2:
#   Single GTID range specified
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0 --stop-position=0-1-2 | MYSQL
DROP TABLE t1;
#
#   Test Case 3:
#   Single GTID range with different server_ids
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=1-2-0 --stop-position=1-3-4 | MYSQL
DROP TABLE t1;
DROP TABLE t2;
#
#   Test Case 4:
#   Multiple GTID ranges specified
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0,1-2-0 --stop-position=0-1-3,1-2-3 | MYSQL
DROP TABLE t1;
DROP TABLE t2;
#
#   Test Case 5:
#   Multiple GTID ranges specified where the domain ids are listed in
# different orders between start/stop position
# MYSQL_BINLOG BINLOG_FILE_PARAM --stop-position=0-1-3,1-2-3 --start-position=1-2-0,0-1-0 | MYSQL
DROP TABLE t1;
DROP TABLE t2;
#
#   Test Case 6:
#   Only start position specified
CREATE TABLE t1 (a int);
INSERT INTO t1 values (3), (4);
DROP TABLE t1;
CREATE TABLE t1 (a int);
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-2 | MYSQL
DROP TABLE t1;
DROP TABLE t2;
#
#   Test Case 7:
#   Only stop position specified
# MYSQL_BINLOG BINLOG_FILE_PARAM --stop-position=0-1-2 | MYSQL
DROP TABLE t1;
#
#   Test Case 8:
#   Seq_no=0 in --start-position includes all events for a domain
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0,1-2-0 | MYSQL
DROP TABLE t1;
DROP TABLE t2;
#
#   Test Case 9:
#   Seq_no=0 in --stop-position excludes all events for a domain
# MYSQL_BINLOG BINLOG_FILE_PARAM --stop-position=0-1-0,1-2-0 | MYSQL
#
#   Test Case 10:
#   Output stops for all domain ids when all --stop-position GTID values
# have been hit.
# MYSQL_BINLOG BINLOG_FILE_PARAM --stop-position=0-1-2 | MYSQL
DROP TABLE t1;
#
#   Test Case 11:
#   All GTID events from other domains are printed until the
# --stop-position values are hit
# MYSQL_BINLOG BINLOG_FILE_PARAM --stop-position=1-3-4 | MYSQL
DROP TABLE t1;
DROP TABLE t2;
#   Test Case 12:
#   Scalar and GTID values can be used together for stop or start
# position
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=4 --stop-position=0-1-1 | MYSQL
DROP TABLE t1;
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0 --stop-position=512 | MYSQL
DROP TABLE t1;
#   Test Case 13:
#   Start position is delayed within the binlog
CREATE TABLE t1 (a int);
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-1 --stop-position=0-1-2 | MYSQL
NOT FOUND /WARNING/ in mysqld.1.err
DROP TABLE t1;
#   Test Case 14:
#   Start position is specified twice on the command line
CREATE TABLE t1 (a int);
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0 --start-position=0-1-1 --stop-position=0-1-2 | MYSQL
DROP TABLE t1;
#   Test Case 15:
#   Stop position is specified twice on the command line
# MYSQL_BINLOG BINLOG_FILE_PARAM --start-position=0-1-0 --stop-position=0-1-1 --stop-position=0-1-2 | MYSQL
DROP TABLE t1;
##############################
#      Error Cases
##############################
#
#   Error Case 1:
#   User provides invalid positions
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=z
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=1-
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=1-2
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=1-2-
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=-1
#
#   Error Case 2:
#   User provides GTID ranges with repeated domain ids
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-1,0-1-8 --stop-position=0-1-4,0-1-12
#
#   Error Case 3:
#   --stop-position is not strictly greater than --start-position
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-2 --stop-position=0-1-1
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-1 --stop-position=0-1-1
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-2,1-2-1 --stop-position=0-1-1,1-2-2
####################################################
#      Warning Case Group 1
#      Run test cases with strict-gtid-mode
####################################################
#
#   Warning Case 1:
#   A gap in sequence number at end of window results in a warning
RESET MASTER;
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
INSERT INTO t1 values (1);
INSERT INTO t1 values (2);
SET @@session.gtid_seq_no= 5;
INSERT INTO t1 values (3);
FLUSH LOGS;
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-0 --stop-position=0-1-4 --gtid-strict-mode 2> log_error_ > OUT_FILE
FOUND 1 /WARNING/ in out.err
DROP TABLE t1;
#
#   Warning Case 2:
#   A gap in sequence number at beginning of window results in a warning
RESET MASTER;
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
SET @@session.gtid_seq_no= 3;
INSERT INTO t1 values (1);
FLUSH LOGS;
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-1 --gtid-strict-mode > log_error_ > OUT_FILE
FOUND 1 /WARNING/ in out.err
DROP TABLE t1;
#
#   Warning Case 3:
#   A gap in sequence number within a window results in a warning
RESET MASTER;
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
INSERT INTO t1 values (1);
SET @@session.gtid_seq_no= 4;
INSERT INTO t1 values (2);
FLUSH LOGS;
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-0 --stop-position=0-1-4 --gtid-strict-mode 2> log_error_ > OUT_FILE
FOUND 1 /WARNING/ in out.err
DROP TABLE t1;
#
#   Warning Case 4:
#   When invoked with just --start-position, a gap in sequence number
# after the provided GTID results in a warning
RESET MASTER;
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
INSERT INTO t1 values (1);
SET @@session.gtid_seq_no= 4;
INSERT INTO t1 values (2);
FLUSH LOGS;
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-0 --gtid-strict-mode 2> log_error_ > OUT_FILE
FOUND 1 /WARNING/ in out.err
DROP TABLE t1;
#
#   Warning Case 5:
#   When invoked with just --stop-position, a gap in sequence number
# before the provided GTID results in a warning
RESET MASTER;
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
INSERT INTO t1 values (1);
SET @@session.gtid_seq_no= 4;
INSERT INTO t1 values (2);
FLUSH LOGS;
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --stop-position=0-1-4 --gtid-strict-mode 2> log_error_ > OUT_FILE
FOUND 1 /WARNING/ in out.err
DROP TABLE t1;
#
#   Warning Case 6:
#   One domain has a sequence number gap but another does not results in
# a warning
RESET MASTER;
SET @@session.gtid_domain_id= 1;
SET @@session.server_id= 2;
CREATE TABLE t2 (a int);
INSERT INTO t2 values (1);
INSERT INTO t2 values (2);
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
INSERT INTO t1 values (1);
SET @@session.gtid_seq_no= 4;
INSERT INTO t1 values (2);
FLUSH LOGS;
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-0,1-2-0 --stop-position=0-1-4,1-2-3 --gtid-strict-mode 2> log_error_ > OUT_FILE
FOUND 1 /WARNING/ in out.err
DROP TABLE t1;
DROP TABLE t2;
####################################################
#      Warning Case Group 2
#      Run test cases with --skip-strict-gtid-mode
####################################################
#
#   Warning Case 1:
#   A gap in sequence number at end of window results in a warning
RESET MASTER;
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
INSERT INTO t1 values (1);
INSERT INTO t1 values (2);
SET @@session.gtid_seq_no= 5;
INSERT INTO t1 values (3);
FLUSH LOGS;
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-0 --stop-position=0-1-4 --skip-gtid-strict-mode 2> log_error_ > OUT_FILE
NOT FOUND /WARNING/ in out.err
DROP TABLE t1;
#
#   Warning Case 2:
#   A gap in sequence number at beginning of window results in a warning
RESET MASTER;
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
SET @@session.gtid_seq_no= 3;
INSERT INTO t1 values (1);
FLUSH LOGS;
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-1 --skip-gtid-strict-mode > log_error_ > OUT_FILE
NOT FOUND /WARNING/ in out.err
DROP TABLE t1;
#
#   Warning Case 3:
#   A gap in sequence number within a window results in a warning
RESET MASTER;
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
INSERT INTO t1 values (1);
SET @@session.gtid_seq_no= 4;
INSERT INTO t1 values (2);
FLUSH LOGS;
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-0 --stop-position=0-1-4 --skip-gtid-strict-mode 2> log_error_ > OUT_FILE
NOT FOUND /WARNING/ in out.err
DROP TABLE t1;
#
#   Warning Case 4:
#   When invoked with just --start-position, a gap in sequence number
# after the provided GTID results in a warning
RESET MASTER;
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
INSERT INTO t1 values (1);
SET @@session.gtid_seq_no= 4;
INSERT INTO t1 values (2);
FLUSH LOGS;
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-0 --skip-gtid-strict-mode 2> log_error_ > OUT_FILE
NOT FOUND /WARNING/ in out.err
DROP TABLE t1;
#
#   Warning Case 5:
#   When invoked with just --stop-position, a gap in sequence number
# before the provided GTID results in a warning
RESET MASTER;
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
INSERT INTO t1 values (1);
SET @@session.gtid_seq_no= 4;
INSERT INTO t1 values (2);
FLUSH LOGS;
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --stop-position=0-1-4 --skip-gtid-strict-mode 2> log_error_ > OUT_FILE
NOT FOUND /WARNING/ in out.err
DROP TABLE t1;
#
#   Warning Case 6:
#   One domain has a sequence number gap but another does not results in
# a warning
RESET MASTER;
SET @@session.gtid_domain_id= 1;
SET @@session.server_id= 2;
CREATE TABLE t2 (a int);
INSERT INTO t2 values (1);
INSERT INTO t2 values (2);
SET @@session.gtid_domain_id= 0;
SET @@session.server_id= 1;
CREATE TABLE t1 (a int);
INSERT INTO t1 values (1);
SET @@session.gtid_seq_no= 4;
INSERT INTO t1 values (2);
FLUSH LOGS;
# MYSQL_BINLOG MYSQLD_DATADIR/master-bin.000001 --start-position=0-1-0,1-2-0 --stop-position=0-1-4,1-2-3 --skip-gtid-strict-mode 2> log_error_ > OUT_FILE
NOT FOUND /WARNING/ in out.err
DROP TABLE t1;
DROP TABLE t2;
##############################
#      Cleanup
##############################
SET @@global.gtid_domain_id= 0;
SET @@global.server_id= 1;
